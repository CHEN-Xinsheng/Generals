# Generals 将军棋

2022-2023 学年春季学期《数字逻辑设计》课程项目

## 模块划分

1. 输入处理模块
2. 游戏逻辑模块
3. 输出处理模块

## 输入处理模块

### 输入

键盘的 `WASD` 、空格、`Z` 。

- `WASD` ：移动光标位置
- 空格：改变当前模式（选择模式、行棋模式）
  - 选择模式：只移动光标位置，不操作。初始为此模式。
  - 行棋模式：对当前位置进行操作。
- `Z` ：改变行棋模式（全移模式、半移模式）。
  - 仅当当前处于“行棋模式”时响应，处于“选择模式”时不响应。
  - 全移模式：从当前格子兵力（$n$）派出 $n-1$ 到目标位置
  - 半移模式：从当前格子兵力（$n$）派出 $\left \lfloor \frac{n}{2} \right \rfloor$到目标位置

### 功能

将键盘输入的扫描码转换为约定的信号，给游戏逻辑模块。

### 输出约定

使用一个锁（1 位 reg）与“游戏逻辑模块”交互：
- 当“输入处理模块”要写入数据时，将锁从 1 置为 0（解锁），并写入数据
  - 如果要写入数据时，发现锁已经是 0（处于解开状态），可能需要特殊处理？
- “游戏逻辑模块”在每个时钟周期检查一次这个锁。如果发现锁是 0 （处于解开状态），就读取数据，并将锁置为 1（上锁）

本模块输出数据：
- 3 位 reg：
  - W：000
  - A：001
  - S：010
  - D：011
  - 空格：100
  - Z：101

## 游戏逻辑模块

### 输入

“输入处理模块”的输出。

### 功能

先判断光标移动是否合法。

然后判断本次操作是否是棋子移动。

进行结算。

将修改后的棋盘返回给“输出处理模块”。

### 输出

使用一个锁（1 位 reg）与“输出处理模块”交互：
- 当“游戏逻辑模块”要写入数据时，将锁从 1 置为 0（解锁），并写入数据
  - 如果要写入数据时，发现锁已经是 0（处于解开状态），可能需要特殊处理？
- “输出处理模块”在每个时钟周期检查一次这个锁。如果发现锁是 0 （处于解开状态），就读取数据、渲染画面，并将锁置为 1（上锁）

本模块输出数据包含：

- 一个数组，表示棋盘每个格子的信息。详见以下“棋盘数据结构”
- 当前回合玩家：3 位 reg
- 当前光标所在格：8 位 reg
  - 横坐标：4 位 reg
  - 纵坐标：4 位 reg
- 当前光标所处模式：2 位 reg
  - 选择模式：00
  - 行棋模式
    - 全移模式：10
    - 半移模式：11

## 输出处理模块

### 输入

即“游戏逻辑模块”的输出。

### 功能

根据输入的结构体数组，渲染出页面。

## 随机初始地图

使用 python 脚本生成 128 张初始地图，写入 MIF 文件。在游戏开始时随机抽签使用一张地图（见以下“游戏初始局面”部分）。

每张初始地图包含以下的特殊元素（其他位置为 NPC 普通领地）：
- 2 个随机王城位置。保证这两个位置之间联通（即存在一条不经过“山”的道路），且距离充分大（哈密顿距离不少于棋盘宽度的 1.2 倍）。
- 随机 NPC 元素。总数为棋盘格子数的 0.24 至 0.31 倍。包含山和 NPC 塔两种元素，任意一者比例在 0.35 至 0.65。

MIF 文件编码如下（棋盘宽度为 10 ）：
- 每个 word 表示一个特殊元素，大小为 10 bit
  - 该元素横坐标（h 坐标）：4 bit
  - 该元素横坐标（v 坐标）：4 bit
  - 该元素类型：2 bit
    - 山：     00
    - NPC 塔： 01
    - 红方王城：10
    - 蓝方王城：11
- 一个棋盘包含不多于 32 个特殊元素，占用 32 word
  - 若特殊元素数目不足 32 ，剩下的 word 的 (h, v) 记为 (0xF, 0xF) ，表示该 word 仅用于填充至 32 word（也相当于表示该格为 NPC 普通领地）
- MIF 文件包含 128 张初始地图
  - 初始地址依次为 0, 32, ..., 32*127

## 游戏规则

### 操作规则

通过 WASD 在棋盘中移动光标，允许移动的范围为全棋盘。

移动到想要操作的目标位置后，敲击空格可以将光标模式由“选择模式”切换到“行棋模式”。但是，如果光标当前不在自己所属的领地，那么模式切换操作无效；并且，如果光标在自己领地但是该位置兵力为 1，也无法切换到“行棋模式”。

切换到“行棋模式”后，再操作 WASD 即可完成一步行棋。再敲击空格也可以切换回“选择模式”。

#### 两种行棋模式

在“行棋模式”下，敲击 Z 可以切换“全移模式”和“半移模式”

- 全移模式：源位置保留 1 兵力，其余兵力都派出
- 半移模式：派出原位置兵力的一半（下取整）的兵力

### 棋盘元素

棋盘大小是 10*10 。

每个格子是以下几种状态之一：

- 归属于 NPC 
  - 空白格
    - 兵力 0
  - 障碍物（山）
  - NPC 塔（城市）
    - 初始兵力为 0，且不会增长；直到它被任意玩家占领之后，才开始增长
- 玩家 1 领地
  - 王城（有且仅有一个）
  - 塔（非负整数个，仅能通过占领 NPC 塔得到）
  - 普通领地
  - 需要维护的元素：兵力，每个格子兵力 >= 0
- 玩家 2 领地（同上）

兵力上限 511。

#### 棋盘数据结构

棋盘是一个 10*10 的格子数组。

每个格子记录以下数据：
- 格子种类：
  - 归属方：3 位 reg
    - NPC：0
    - 玩家 1（红方）：1
    - 玩家 2（蓝方）：2
  - 种类：2 位 reg
    - 普通领地（含空白格）：0
    - 山：1
    - 王城：2
    - 塔（城市）：3
- 兵力：9 位 reg

### 游戏初始局面

- 项目运行时，即启动一个抽签器（循环计数器），计数范围是 [0, MAX_RANDOM_TIMER = 128] ，频率是 `Game_Player` 的 clock 频率，即 50 MHz。
- 按下 `reset` 时，该抽签器置 0。
- 按下 `clock_btn` 时，根据抽签器此时的数，随机产生先手玩家和一张初始地图
  - 先手玩家：抽签器的数为奇数/偶数，选择红方/蓝方先手。
  - 初始地图：从 128 张初始地图中选择对应的一张。

### 兵力增长机制

1 回合指所有玩家各操作一次。

对于每个玩家的领地：
- 王城：每 1 回合结束时，增长 1
- 塔：每 1 回合结束时，增长 1
- 普通领地：每 16 回合结束时，增长 1
